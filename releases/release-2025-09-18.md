# Release 2025-09-18

Bu sürüm; kimlik doğrulama akışı, sayfa koruma (middleware + SSR), callback sayfası UI/UX iyileştirmeleri, favicon düzeltmesi, ve eksiksiz “Forgot / Reset Password” akışını içerir.

## Özet
- Callback sayfası DarkVeil arkaplanı ve shadcn kart ile yeniden tasarlandı, tüm içerik merkezde.
- Yeşil tik sola yatık ve ortalı; hiyerarşi, spacing ve responsive iyileştirildi.
- Buton davranışları netleştirildi: turuncu “Close this page”, ikincil “Continue here”.
- Giriş sonrası Dashboard Shell’in manuel yenilemeye gerek kalmadan gelmesi sağlandı.
- Tüm app sayfaları (root `/` ve `/auth/*` hariç) korunuyor; middleware ve SSR guard’lar güncellendi.
- Vercel default favicon yerine proje ikonunuz üretildi ve kullanılıyor.
- Forgot / Reset Password akışı eklendi (Supabase ile üretim seviyesinde, tek sekme deneyimi korunarak).

## Değişiklikler

### Auth Callback UI
- Dosya: `src/app/auth/callback/page.tsx`
  - DarkVeil tam ekran sabit arkaplan olarak eklendi.
  - Kart daha geniş ve responsive (max-width arttırıldı), tüm içerik dikey/yatay ortalı.
  - Başlık (header) büyütüldü; yeşil tik sola yatık ve ortada konumlandırıldı.
  - Buton hiyerarşisi güncellendi: birincil (turuncu) “Close this page”, ikincil “Continue here”.
  - Spacing/hiyerarşi: açıklama metni butona yaklaştırıldı; alt boşluk optimize edildi.

### Giriş (Sign-in) sonrası Dashboard Shell yüklenmesi
- Dosya: `src/features/auth/components/supabase-signin-form.tsx`
  - `signInWithPassword` sonrası session’ın oluşmasını kısa bir bekleme ile doğrulama eklendi.
  - Önce SPA yönlendirme (`router.replace` + `router.refresh`), son çare olarak hard reload ile `/dashboard` garantilendi.

### Route Koruma (Middleware + SSR)
- Dosya: `middleware.ts`
  - Sadece `/` ve `/auth/*` public; diğer tüm yollar korumalı.
  - `/auth/callback` oturum varken de erişilebilir bırakıldı (başarılı ekran için).
  - Statik varlıklar ve `/api` bypass ediliyor; Supabase cookie yazımı korunuyor.
- SSR Guard eklenen/iyileştirilen layout’lar:
  - `src/app/chat/layout.tsx`
  - `src/app/contacts/layout.tsx`
  - `src/app/settings/layout.tsx`
  - `src/app/shipments/layout.tsx`
  - `src/app/profile/layout.tsx`
  - `src/app/nobledocs/layout.tsx`

### Favicon
- Script: `scripts/generate-favicon.mjs`
  - `public/logo_meta.svg` kaynağından çok boyutlu `public/favicon.ico` ve `public/favico.ico` üretimi.
  - Kullanılan paketler: `to-ico`, `sharp`.
- Metadata:
  - `src/app/layout.tsx` zaten `/favicon.ico` fallback içeriyor.

### Forgot / Reset Password (Yeni)
- Dosyalar:
  - `src/app/auth/forgot-password/page.tsx`
    - E-posta girişi ile `supabase.auth.resetPasswordForEmail(email, { redirectTo: '/auth/reset-password' })` çağrısı.
    - Rate limit durumunda ("email rate limit exceeded") kullanıcıya linkin gönderildiği bilgisi veriliyor ve 60s client-side cooldown başlatılıyor (spam/email enumeration önleme).
    - UI kalınlaştırma: input’lar `h-11 text-base`, buton `size='lg'`.
  - `src/app/auth/reset-password/page.tsx`
    - Token işleme iki yolla desteklenir:
      1) URL hash: `#type=recovery&access_token&refresh_token` → `supabase.auth.setSession` ile oturum kurulumu.
      2) Query: `?code=<token_hash>` → `supabase.auth.verifyOtp({ type: 'recovery', token_hash: code })`.
    - Şifre güncelleme: `supabase.auth.updateUser({ password })` sonrası cookie/sunum katmanı senkronizasyonu için kısa bekleme, `router.replace('/dashboard') + router.refresh` ve gerekirse hard reload fallback.
    - UI kalınlaştırma: input’lar `h-11 text-base`, buton `size='lg'`.
- E-posta şablonu düzeltmesi:
  - Reset e-posta buton linki `{{ .RedirectTo }}` yerine `{{ .ConfirmationURL }}` olarak güncellendi. Böylece Supabase’in token’lı güvenli linki kullanılır ve link geçerliliği sağlanır.

## Nasıl Doğrulanır
- E-posta doğrulama linkine tıklandığında: callback sayfasında DarkVeil arkaplanı ve kart görünür; “Close this page” sayfayı kapatmayı dener.
- Giriş yaptıktan sonra: `/dashboard` anında shell ile açılır; manuel yenilemeye gerek kalmaz.
- Oturum yokken korumalı sayfalara (örn. `/shipments`) girmek: middleware/SSR ile engellenir.
- Favicon: tarayıcıda site sekmesinde özelleştirilmiş ikon görünür (gerekirse hard refresh).
- Forgot / Reset Password: `/auth/forgot-password` → mail → link tıklama → `/auth/reset-password` → şifre güncelle → otomatik `/dashboard` yönlendirmesi.

## Notlar
- `window.close()` sadece script ile açılan pencerelerde çalışır; e-posta linki aynı sekmede açıldıysa çağrı güvenli biçimde yok sayılır.
- DarkVeil görünürlüğü için tint/noise/scanline ayarları callback sayfasında parametrik olarak verildi; istenirse kolayca değiştirilebilir.
- Supabase Auth → URL Configuration → Additional Redirect URLs listesine prod ve lokal için `/auth/reset-password` ve `/auth/callback` adresleri eklendiğinden emin olun.
- Rate limit kaynaklı tekrar taleplerinde kullanıcıya nazik bir bilgi verilir; 60s cooldown UI’da geri sayım olarak görünür.
